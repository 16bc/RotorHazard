{% extends "layout.html" %} {% block title %}Settings{% endblock %} {% block head %}
<script type="text/javascript" charset="utf-8">
	$(document).ready(function () {
		var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

		// construct language selection
		$('#voice_select').after('<select class="set_language">');
		var voices = $().articulate('getVoices');

		for (var i in voices) {
			$('.set_language').append('<option>'+ voices[i].name + '</option>');
		}
		$('.set_language').val(d5rt.language).attr('selected', 'selected');

		socket.on('heartbeat', function (msg) {
			for (i = 0; i < msg.current_rssi.length; i++) {
				$('.current_rssi_' + i).html(msg.current_rssi[i]);
			}
		});

		socket.on('node_data', function (msg) {
			for (i = 0; i < msg.frequency.length; i++) {
				$('.channel_' + i).html(msg.channel[i] + ' ' + msg.frequency[i]);
				$('.s_channel_' + i).val(msg.frequency[i]);
				$('.trigger_rssi_' + i).html(msg.trigger_rssi[i]);
				$('.peak_rssi_' + i).html(msg.peak_rssi[i]);
			}
		});

		socket.on('node_tuning', function (msg) {
			$('.set_calibration_threshold').val( msg.calibration_threshold);
			$('.set_calibration_offset').val( msg.calibration_offset);
			$('.set_trigger_threshold').val( msg.trigger_threshold);
			$('.set_profile_name').val( msg.profile_name);
			$('.set_profile_description').val( msg.profile_description);

		});

		socket.on('set_fix_race_time', function (msg) {
			$('.set_fix_race_time').val( msg.fix_race_time);
		});

		socket.on('heat_data', function (msg) {
			$.each(msg.heat_id, function (i, heat_id) {
				$.each(heat_id.callsign, function (j, callsign) {
					$('.heat_' + (i + 1) + '_node_' + j).val(callsign);
				});
			});
		});

		socket.on('pilot_data', function (msg) {
			for (i = 0; i < msg.callsign.length; i++) {
				$('.callsign_' + i).attr('value', msg.callsign[i]);
				$('.name_' + i).attr('value', msg.name[i]);
			}
		});

		socket.on('speak_phonetic_text', function (msg) {
			var $ttstext = msg.text;
			speak('<div class="speech">' + $ttstext + '</div> div.speech');
		})

		$('.set_frequency').change(function (event) {
			var data = {
				node: parseInt($(this).data('node')),
				frequency: parseInt($(this).val()),
			};
			socket.emit('set_frequency', data);
		});

		$('.set_language').change(function (event) {
			d5rt.language = $(this).val();
			d5rt.saveData();
		});

		$('.set_pilot_position').change(function (event) {
			var data = {
				heat: parseInt($(this).data('heat')),
				node: parseInt($(this).data('node')),
				pilot: parseInt($(this).val())
			};
			socket.emit('set_pilot_position', data);
		});

		$('.set_pilot_callsign').change(function (event) {
			var data = {
				pilot_id: parseInt($(this).data('pilot_id')),
				callsign: $(this).val()
			};
			socket.emit('set_pilot_callsign', data);
		})

		$('.set_pilot_phonetic').change(function (event) {
			var data = {
				pilot_id: parseInt($(this).data('pilot_id')),
				phonetic: $(this).val()
			};
			socket.emit('set_pilot_phonetic', data);
		})

		$('.set_pilot_name').change(function (event) {
			var data = {
				pilot_id: parseInt($(this).data('pilot_id')),
				name: $(this).val()
			};
			socket.emit('set_pilot_name', data);
		})

		$('.set_calibration_threshold').change(function (event) {
			var data = {
				calibration_threshold: parseInt($(this).val())
			};
			socket.emit('set_calibration_threshold', data);
		})

		$('.set_calibration_offset').change(function (event) {
			var data = {
				calibration_offset: parseInt($(this).val())
			};
			socket.emit('set_calibration_offset', data);
		})

		$('.set_trigger_threshold').change(function (event) {
			var data = {
				trigger_threshold: parseInt($(this).val())
			};
			socket.emit('set_trigger_threshold', data);
		})
		$('.set_profile_name').change(function (event) {
			var data = {
				profile_name: $(this).val()
			};
			socket.emit('set_profile_name', data);
			window.location.href = "/settings";
		})

		$('.set_profile_description').change(function (event) {
			var data = {
				profile_desciption: $(this).val()
			};
			socket.emit('set_profile_desciption', data);
		})

		$('button#add_heat').click(function (event) {
			socket.emit('add_heat');
			window.location.href = "/settings"; // Update to not need page reload
			// This isn't getting an updated database I think
			// $( "#heats" ).empty();
			// document.getElementById("heats").innerHTML = // jinja template include
			return false;
		});

		$('button#add_pilot').click(function (event) {
			socket.emit('add_pilot');
			window.location.href = "/settings"; // Update to not need page reload
			// This isn't getting an updated database I think
			// $( "#heats" ).empty();
			// document.getElementById("heats").innerHTML = // jinja template include
			return false;
		});
		$('button#speak_pilot').click(function (event) {
			var data = {
				pilot_id: parseInt($(this).data('pilot_id')),
				phonetic: $(this).val()
			};
			socket.emit('speak_pilot', data);
			return false;
		});
		$('button#add_profile').click(function (event) {
			socket.emit('add_profile');
			window.location.href = "/settings"; // Update to not need page reload
			return false;
		});
		$('button#delete_profile').click(function (event) {
			socket.emit('delete_profile');
			window.location.href = "/settings"; // Update to not need page reload
			return false;
		});
		$('button#reset_database').click(function (event) {
			socket.emit('reset_database');
			window.location.href = "/settings"; // Update to not need page reload
			return false;
		});

		$('button#reset_database_keep_pilots').click(function (event) {
			socket.emit('reset_database_keep_pilots');
			window.location.href = "/settings"; // Update to not need page reload
			return false;
		});

		$('button#shutdown_pi').click(function (event) {
			socket.emit('shutdown_pi');
			return false;
		});

		$('.set_profile').change(function (event) {
			var data = {
				profile: $(this).val()
			};
			socket.emit('set_profile', data);
		});

		$('.set_fix_race_time').change(function (event) {
			var data = {
				race_time: parseInt($(this).val())
			};
			socket.emit('set_fix_race_time', data);
		})

	});

	function speak(obj) {
		$(obj).articulate('setVoice','name', d5rt.language).articulate('speak');
	};

</script>
{% endblock %} {% block content %}
<main class="page-settings">

<!--Display node data-->
<h2>Nodes</h2>
<div class="node-list">
	{% for node in range(num_nodes) %}
	<div class="node">
		<h3>Node {{ node + 1 }}</h3>
		<table class="table">
			<tr>
				<td colspan="2">
					<select class="set_frequency s_channel_{{ node }}" data-node="{{ node }}">
						{% for frequency in frequencies.query.all() %}
						<option value="{{ frequency.frequency }}">
							{{ frequency.channel }} {{ frequency.frequency }}
						</option>
						{% endfor %}
					</select>
				</td>
			</tr>
			<tr>
				<td>RSSI</td>
				<td>
					<span class="current_rssi_{{ node }}"></span>
				</td>
			</tr>
			<tr>
				<td>Trigger</td>
				<td>
					<span class="trigger_rssi_{{ node }}"></span>
				</td>
			</tr>
			<tr>
				<td>Peak</td>
				<td>
					<span class="peak_rssi_{{ node }}"></span>
				</td>
			</tr>
		</table>
	</div>
	{% endfor %}
</div>

<!--Heats list for editing-->
<h2>Heats</h2>
<button type="button" class="btn btn-default" id="add_heat" onclick="this.blur();">Add Heat</button>

<p>Don't change a heat after it has a saved race.</p>
<div id="heatsetup" class="heats">
	{% for heat in heats.query.with_entities(heats.heat_id).distinct() %}
	<div class="heat">
		<h3>Heat {{ heat.heat_id }}</h3>
		<table class="table">
			{% for node in range(num_nodes) %}
			<tr>
				<td>
					<div class="channel_{{ node }}"></div>
				</td>
				<td>
					<select class="set_pilot_position heat_{{ heat.heat_id }}_node_{{ node }}" data-heat="{{ heat.heat_id }}" data-node="{{ node }}">
						{% set heatpilotid = pilots.query.filter_by(pilot_id=
							heats.query.filter_by(heat_id=heat.heat_id,node_index=node).first().pilot_id
							).first().pilot_id %}
						{% for pilot in pilots.query.all() %}
						<option value="{{ pilot.pilot_id }}"
							{% if pilot.pilot_id|int() == heatpilotid|int() %}
								selected="selected"
							{% endif %}>
							{{ pilot.callsign }} ({{ pilot.name }})
						</option>
						{% endfor %}
					</select>
				</td>
			</tr>
			{% endfor %}
		</table>
	</div>
	{% endfor %}
</div>

<!--Pilots list for editing-->
<h2>Pilots</h2>
<button type="button" id="add_pilot" onclick="this.blur();">Add Pilot</button>
<p>Spelling corrections only after saving races.</p>
<div class="row">
	<div class='col-xs-16 col-md-8'>
		<div class='panel panel-default'>
			<table class="table">
				<thead>
					<tr>
						<th>Pilot ID</th>
						<th>Call Sign</th>
						<th>Phonetic</th>
						<th class="speak"></th>
						<th>Name</th>
						</tr>
				</thead>
				<tbody>
					{% for pilot in pilots.query.all() %} {% if pilot.pilot_id != 0 %}
					<tr>
						<td>{{ pilot.pilot_id }}</td>
						<td>
							<input type="text" class="set_pilot_callsign callsign_{{ pilot.pilot_id }}" data-pilot_id="{{ pilot.pilot_id }}"
							 value="{{ pilot.callsign }}">
						</td>
						<td>
							<input type="text" class="set_pilot_phonetic phonetic_{{ pilot.pilot_id }}" data-pilot_id="{{ pilot.pilot_id }}"
							 value="{{ pilot.phonetic }}">
						</td>
						<td class="speak">
							<button type="button" id="speak_pilot" onclick="this.blur();" data-pilot_id="{{ pilot.pilot_id }}">&#9658;</button>
						</td>
						<td>
							<input type="text" class="set_pilot_name name_{{ pilot.pilot_id }}" data-pilot_id="{{ pilot.pilot_id }}" value="{{ pilot.name }}">
						</td>
					</tr>
					{% endif %} {% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>

<h2>Fixed Race Time</h2>
<table class="table">
	<tr>
		<td><b>Time</b><br> maximum race time in seconds</td>
		<td>
			<input type="text" class="form-control set_fix_race_time" value="{{current_fix_race_time}}">
		</td>
	</tr>
 </table>

<!--Display Voice-->
<h2 id="voice_select">Voice Selection</h2>

<!--Edit system tuning values-->
<h2>Sensor Tuning</h2>

<h3>Profile</h3>
<select class="set_profile">
	{% for profile in profiles.query.all() %}
	<option value="{{profile.name}}" {% if profile.name == profiles.query.get(last_profile.query.get(1).profile_id).name %}
			selected="selected"
		{% endif %}>
		{{profile.name}}
	</option>
	{% endfor %}
</select>

<button type="button" class="btn btn-default" id="add_profile" onclick="this.blur();">+</button>
<button type="button" class="btn btn-default" id="delete_profile" onclick="this.blur();">&#215;</button>

<table class="table">
	<tr>
		<td><b>Name</b></td>
		<td><input type="text" class="set_profile_name"></td>
	</tr>
	<tr>
		<td><b>Description</b></td>
		<td><textarea class="set_profile_description"></textarea>
	</tr>
	<tr>
		<td><b>Calibration Offset (Default 8)</b><br>Trigger is Peak Rssi minus Calibration Offset</td>
		<td>
			<input type="text" class="set_calibration_offset">
		</td>
	</tr>
	<tr>
		<td><b>Calibration Threshold (Default 95)</b><br>Trigger minus Calibration Threshold ends calibration pass</td>
		<td>
			<input type="text" class="set_calibration_threshold">
		</td>
	</tr>
	<tr>
		<td><b>Trigger Threshold (Default 40)</b><br>Trigger minus Trigger Threshold ends normal pass</td>
		<td>
			<input type="text" class="set_trigger_threshold">
		</td>
	</tr>
</table>

<!--Reset database-->
<h2>Database (Copy out any saved races first!)</h2>
<div>
	<button type="button" class="btn-danger" id="reset_database" onclick="this.blur();">Reset Database</button>
	<button type="button" class="btn-warning" id="reset_database_keep_pilots" onclick="this.blur();">Reset Keep Pilots</button>
</div>

<!-- Shut down -->
<h2>System (Safely shutdown raspberry pi)</h2>
<div>
	<button type="button" class="btn-danger" id="shutdown_pi" onclick="this.blur();">Shutdown</button>
</div>

<h2>Debug</h2>
<ul>
	<li><a href="/hardwarelog">Log</a></li>
	<li><a href="/database">Database</a></li>
</ul>

</main>
{% endblock %}
