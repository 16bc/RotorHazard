{% extends "layout.html" %} {% block title %}Run{% endblock %}{% block head %}

<script type="text/javascript" charset="utf-8">
	var race_list = {};
	var current_race_data = {};

	$(document).ready(function () {
		var graph_canvas = document.getElementById('race-graph');
		var graph = new SmoothieChart({
			responsive: true,
			grid:{
				strokeStyle:'rgba(255,255,255,0.25)',
				sharpLines:true,
				verticalSections:0,
				borderVisible:false
			},
			labels:{
				precision: 0
			},
			scaleSmoothing: 1
		});
		var graph_series = new TimeSeries();
		graph.addTimeSeries(graph_series, {lineWidth:1.7,
			strokeStyle:'hsl(214, 53%, 60%)',
			fillStyle:'hsla(214, 53%, 60%, 0.4)'
		});
		graph.streamTo(graph_canvas, 1);
		graph.stop();

		socket.emit('load_data', {'load_types': [
			'all_languages',
			'language',
			'race_list',
		]});

		socket.on('all_languages', function (msg) {
			rotorhazard.language_strings = msg.languages;
		});

		socket.on('language', function (msg) {
			if (msg.language) {
				rotorhazard.interface_language = msg.language;
			}
		});

		socket.on('race_list', function (msg) { // *** use a simplified round data socket so the leaderboards don't have to process
			race_list = msg;

			$('#selected_heat').empty();
			$('#selected_heat').append('<option value="">' + __('Select Heat') + '</option>');
			for (var heat_i in race_list.heats) {
				var heat = race_list.heats[heat_i];

				if (heat.note) {
					var heat_name = heat.note;
				} else {
					var heat_name = __('Heat') + ' ' + heat.heat_id;
				}

				$('#selected_heat').append('<option value="' + heat.heat_id + '">' + heat_name + '</option>');
			}

			// *** don't reload data if current race still exists
		});

		$('#selected_heat').change(function(){
			$('#selected_round').empty();
			$('#selected_round').append('<option value="--">' + __('Select Round') + '</option>');

			var heat = parseInt($(this).val());
			if (heat != '--') {
				for (var round_i in race_list.heats[heat].rounds) {
					var round = race_list.heats[heat].rounds[round_i];

					$('#selected_round').append('<option value="' + round_i + '">' + __('Round') + ' ' + round.id + '</option>');
				}

				// *** don't reload data if current race still exists
			}
		});

		$('#selected_round').change(function(){
			$('#selected_pilot').empty();
			$('#selected_pilot').append('<option value="--">' + __('Select Pilot') + '</option>');

			var heat = parseInt($('#selected_heat').val());
			var round = parseInt($(this).val());

			if (round != '--') {
				for (var node_i in race_list.heats[heat].rounds[round].nodes) {
					var node = race_list.heats[heat].rounds[round].nodes[node_i];

					$('#selected_pilot').append('<option value="' + node_i + '">' + node.pilot + '</option>');
				}

				// *** don't reload data if current race still exists
			}
		});

		$('#load_race').click(function(){
			var heat = parseInt($('#selected_heat').val());
			var round = parseInt($('#selected_round').val());
			var round_id = race_list.heats[heat].rounds[parseInt($('#selected_round').val())].id;
			var node_id = race_list.heats[heat].rounds[round].nodes[parseInt($('#selected_pilot').val())].id;

			var data = {
				heat: heat,
				round: round_id,
				node: node_id
			};
			socket.emit('get_race_meta', data);
			return false;
		});

		function renderGraph() {
			var graphWidth = graph_canvas.offsetWidth;

			var startTime = current_race_data.history_times[0];
			var endTime = current_race_data.history_times[current_race_data.history_times.length - 1];
			var duration = endTime - startTime;
			var span = duration / graphWidth;

			graph.options.millisPerPixel = span;
			graph.render(graph_canvas, endTime);
		}

		socket.on('race_meta', function (msg) {
			current_race_data = msg;

			graph_series.data = [];
			for (idx in current_race_data.history_times) {
				graph_series.append(current_race_data.history_times[idx], current_race_data.race_history[idx])
			}

			renderGraph();
		});

		var resizeTimer;
		$(window).on('resize', function(){
			clearTimeout(resizeTimer);
			resizeTimer = setTimeout(function() {
				renderGraph();
			}, 250);
		});
	});
</script>
{% endblock %} {% block content %}
<main class="page-marshal">

<div class="panel">
	<div class="panel-content">

		<div class="control-set">
			<label for="selected_heat" class="screen-reader-text">{{ __('Heat') }}</label>
			<select id="selected_heat">
				<option value="">{{ __('Loading...') }}</option>
			</select>

			<label for="selected_round" class="screen-reader-text">{{ __('Round') }}</label>
			<select id="selected_round">
				<option value="">{{ __('Loading...') }}</option>
			</select>

			<label for="selected_pilot" class="screen-reader-text">{{ __('Pilot') }}</label>
			<select id="selected_pilot">
				<option value="">{{ __('Loading...') }}</option>
			</select>

			<button id="load_race">{{ __('Load Race') }}</button>
		</div>

		<div class="race-view">
			<canvas id="race-graph" style="width:100%; height:200px"></canvas>
		</div>
	</div>
</div>

</main>
{% endblock %}
